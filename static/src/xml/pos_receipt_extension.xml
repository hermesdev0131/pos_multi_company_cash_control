<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
    <!--
        POS Multi-Company Cash Control: Receipt Extension

        This template extends the standard POS receipt to:
        1. Display the order's assigned company information (fiscal or non-fiscal)
           instead of the session company
        2. Add a QR code on non-fiscal receipts only

        Business Rules:
        - Fiscal receipts: Show fiscal company info (no QR - fiscal printer adds its own)
        - Non-fiscal receipts: Show non-fiscal company info + custom QR code
    -->

    <t t-name="pos_multi_company_cash_control.OrderReceipt"
       t-inherit="point_of_sale.OrderReceipt"
       t-inherit-mode="extension"
       owl="1">

        <!-- Override company name in header -->
        <!-- Try multiple possible XPath selectors for company name -->
        <xpath expr="//div[hasclass('pos-receipt-company')]//h2" position="replace">
            <h2 t-if="order.company_id and order.company_id.name" t-esc="order.company_id.name"/>
            <h2 t-else="" t-esc="receipt.company.name"/>
        </xpath>
        
        <!-- Alternative: Try to find company name by text content -->
        <xpath expr="//h2[contains(text(), receipt.company.name)]" position="replace">
            <h2 t-if="order.company_id and order.company_id.name" t-esc="order.company_id.name"/>
            <h2 t-else="" t-esc="receipt.company.name"/>
        </xpath>

        <!-- Override company contact information -->
        <!-- Try multiple possible XPath selectors -->
        <xpath expr="//div[hasclass('pos-receipt-contact')]" position="replace">
            <div class="pos-receipt-contact">
                <t t-if="order.company_id">
                    <t t-if="order.company_id.street">
                        <div><t t-esc="order.company_id.street"/></div>
                    </t>
                    <t t-if="order.company_id.street2">
                        <div><t t-esc="order.company_id.street2"/></div>
                    </t>
                    <t t-if="order.company_id.city or order.company_id.zip">
                        <div>
                            <t t-if="order.company_id.zip"><t t-esc="order.company_id.zip"/> </t>
                            <t t-if="order.company_id.city"><t t-esc="order.company_id.city"/></t>
                        </div>
                    </t>
                    <t t-if="order.company_id.state_name">
                        <div><t t-esc="order.company_id.state_name"/></div>
                    </t>
                    <t t-if="order.company_id.country_name">
                        <div><t t-esc="order.company_id.country_name"/></div>
                    </t>
                    <t t-if="order.company_id.vat">
                        <div>VAT: <t t-esc="order.company_id.vat"/></div>
                    </t>
                    <t t-if="order.company_id.phone">
                        <div>Tel: <t t-esc="order.company_id.phone"/></div>
                    </t>
                    <t t-if="order.company_id.email">
                        <div>Email: <t t-esc="order.company_id.email"/></div>
                    </t>
                </t>
                <t t-else="">
                    <!-- Fallback to session company -->
                    <t t-if="receipt.company.street">
                        <div><t t-esc="receipt.company.street"/></div>
                    </t>
                    <t t-if="receipt.company.city">
                        <div><t t-esc="receipt.company.city"/></div>
                    </t>
                    <t t-if="receipt.company.vat">
                        <div>VAT: <t t-esc="receipt.company.vat"/></div>
                    </t>
                </t>
            </div>
        </xpath>

        <!-- Add QR code section ONLY for non-fiscal orders -->
        <xpath expr="//div[hasclass('pos-receipt-amount-change')]" position="after">
            <!-- Check if order is NON-FISCAL -->
            <t t-if="!order.is_fiscal_order and order.non_fiscal_qr_data">
                <div class="non-fiscal-qr-section" style="text-align: center; margin-top: 20px; padding: 10px 0; border-top: 1px dashed #000;">
                    <div class="qr-label" style="font-size: 12px; margin-bottom: 10px; font-weight: bold;">
                        Non-Fiscal Transaction
                    </div>
                    <!-- QR Code image generated from backend -->
                    <img t-att-src="'data:image/png;base64,' + order.non_fiscal_qr_data"
                         style="width: 150px; height: 150px; margin: 0 auto; display: block;"/>
                </div>
            </t>
        </xpath>
    </t>
</templates>
