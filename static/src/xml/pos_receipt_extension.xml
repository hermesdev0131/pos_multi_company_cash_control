<?xml version="1.0" encoding="UTF-8"?>
<templates id="template" xml:space="preserve">
    <!--
        POS Multi-Company Cash Control: Receipt Extension

        This template extends the standard POS receipt to:
        1. Display the order's assigned company information (fiscal or non-fiscal)
           instead of the session company
        2. Add a QR code on non-fiscal receipts only

        Business Rules:
        - Fiscal receipts: Show fiscal company info (no QR - fiscal printer adds its own)
        - Non-fiscal receipts: Show non-fiscal company info + custom QR code
    -->

    <t t-name="pos_multi_company_cash_control.OrderReceipt"
       t-inherit="point_of_sale.OrderReceipt"
       t-inherit-mode="extension"
       owl="1">

        <!-- 
            CRITICAL: Get company object from models using company_id
            company_id is a Many2one field: [id, name] tuple
            We need to get the full company record from the models
        -->
        <t t-set="order_company_id" t-value="order.company_id and (Array.isArray(order.company_id) ? order.company_id[0] : order.company_id)"/>
        <t t-set="order_company" t-value="order_company_id ? env.pos.models['res.company'].get(order_company_id) : null"/>

        <!-- Override company name in header -->
        <xpath expr="//div[hasclass('pos-receipt-company')]//h2" position="replace">
            <h2>
                <t t-if="order_company">
                    <t t-esc="order_company.name"/>
                </t>
                <t t-else="">
                    <!-- Fallback to session company if order company not loaded -->
                    <t t-esc="receipt.company.name"/>
                </t>
            </h2>
        </xpath>

        <!-- Override company contact information -->
        <xpath expr="//div[hasclass('pos-receipt-contact')]" position="replace">
            <div class="pos-receipt-contact">
                <t t-if="order_company">
                    <!-- Use order's assigned company (fiscal or non-fiscal) -->
                    <t t-if="order_company.street">
                        <div><t t-esc="order_company.street"/></div>
                    </t>
                    <t t-if="order_company.street2">
                        <div><t t-esc="order_company.street2"/></div>
                    </t>
                    <t t-if="order_company.city or order_company.zip">
                        <div>
                            <t t-if="order_company.zip"><t t-esc="order_company.zip"/> </t>
                            <t t-if="order_company.city"><t t-esc="order_company.city"/></t>
                        </div>
                    </t>
                    <t t-if="order_company.state_id">
                        <div><t t-esc="order_company.state_id[1]"/></div>
                    </t>
                    <t t-if="order_company.country_id">
                        <div><t t-esc="order_company.country_id[1]"/></div>
                    </t>
                    <t t-if="order_company.vat">
                        <div>VAT: <t t-esc="order_company.vat"/></div>
                    </t>
                    <t t-if="order_company.phone">
                        <div>Tel: <t t-esc="order_company.phone"/></div>
                    </t>
                    <t t-if="order_company.email">
                        <div>Email: <t t-esc="order_company.email"/></div>
                    </t>
                </t>
                <t t-else="">
                    <!-- Fallback to session company if order company not loaded -->
                    <t t-if="receipt.company.street">
                        <div><t t-esc="receipt.company.street"/></div>
                    </t>
                    <t t-if="receipt.company.city">
                        <div><t t-esc="receipt.company.city"/></div>
                    </t>
                    <t t-if="receipt.company.vat">
                        <div>VAT: <t t-esc="receipt.company.vat"/></div>
                    </t>
                </t>
            </div>
        </xpath>

        <!-- Add QR code section ONLY for non-fiscal orders -->
        <xpath expr="//div[hasclass('pos-receipt-amount-change')]" position="after">
            <!-- Check if order is NON-FISCAL -->
            <t t-if="!order.is_fiscal_order and order.non_fiscal_qr_data">
                <div class="non-fiscal-qr-section" style="text-align: center; margin-top: 20px; padding: 10px 0; border-top: 1px dashed #000;">
                    <div class="qr-label" style="font-size: 12px; margin-bottom: 10px; font-weight: bold;">
                        Non-Fiscal Transaction
                    </div>
                    <!-- QR Code image generated from backend -->
                    <img t-att-src="'data:image/png;base64,' + order.non_fiscal_qr_data"
                         style="width: 150px; height: 150px; margin: 0 auto; display: block;"/>
                </div>
            </t>
        </xpath>
    </t>
</templates>
